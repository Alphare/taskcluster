version: 64
description: Add `queue_worker_seen` and `queue_task_queue_seen` functions
methods:
  create_task_queue: {deprecated: true}
  update_task_queue: {deprecated: true}
  task_queue_seen:
    description: |-
      Recognize that a task queue has been seen, creating it if necessary, updating
      its properties if not null, and in any case bumping its last seen time time. 
      The expiration time is not allowed to move backward.
      
      This function always writes to the DB, so calls should be suitably rate-limited at the
      client side.
    mode: write
    serviceName: queue
    args: task_queue_id_in text, expires_in timestamptz, description_in text, stability_in text
    returns: void
    body: |-
      begin
        insert
          into task_queues (task_queue_id, expires, last_date_active, description, stability)
          values (
            task_queue_id_in,
            expires_in,
            now(),
            coalesce(description_in, ''),
            coalesce(stability_in, 'experimental')
          )
          on conflict (task_queue_id) do update
          set
            expires = greatest(coalesce(expires_in, task_queues.expires), task_queues.expires),
            last_date_active = now(),
            description = coalesce(description_in, task_queues.description),
            stability = coalesce(stability_in, task_queues.stability)
          where task_queues.task_queue_id = task_queue_id_in;
      end
