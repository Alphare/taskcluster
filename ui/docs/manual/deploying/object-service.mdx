---
title: Object Service
order: 22
---

# Object Service

The object service uses "backends" to manage storage of data in cloud providers.
Each is identified by a `backendId`.
When an object is created (uploaded), it is assigned a backend.

## Cautions

Be careful to never remove a backend which still has objects, as those objects will become inaccessible and may not be deleted.

Be careful, too, not to change a backend configuration in such a way that the existing objects will become inaccessible.
For example, do not change the cloud account or bucket for a cloud backend.
Instead, create a new backend for the new account and create new objects in that backend, allowing the old objects to expire.

## Backend Configuration

Backends are configured in the `object.backend` configuration value, which is a JSON object mapping `{ backendId: config }`.
The `config` must contain a `backendType` property giving the type of this backend; the remaining configuration is specific to the backend type, documented below.
It's perfectly fine to have multiple backends with the same type; for example, two backends with different accounts in the same cloud.

For example:

```yaml
backends:
  general-purpose:
    backendType: aws
    # ...
  proj-fuzzing:
    backendType: google
    # ...
```

See the [reference documentation](/docs/reference/platform/object/) for descriptions of the available backends and their configuration.

The backend for a specific object is determined when that object is uploaded, based on the `object.backend_map` configuration value.
This is a JSON array containing a sequence of match expressions.
The first matching expression determines the backend to use; remaining expressions are not considered.

Each match expression has the form `{ backendId: .., when: .. }`, giving the `backendId` to use when the condition is true.
The `when` property gives patterns for the object's `name` and `projectId`, all of which must match.
The pattern can be an exact match, given as `{is: '<value>'}` or just `'<value>'`
It can also be a regular expression, given as `{regexp: '<exp>'}`.
The regular expression is not automatically anchored to the beginning and end of the object name, so it is common to use `^`, e.g., `when: {name: {regexp: '^public/'}}`.
As a special case, `when: 'all'` matches all objects, and is typically used as a catch-all in the last array element.

Putting all of that together:

```yaml
backend_map:
  # project jitterbug gets its own backend
  - backendId: proj-jitterbug
    when:
      projectId: jitterbug

  # project lindy's builds are stored in a dedicated backend
  - backendId: proj-lindy
    when:
      name: {regexp: '^builds/'}
      projectId: {is: 'lindy'}

  # logs are stored in a special reduced-redundancy backend
  - backendId: reduced-redundancy
    when:
      name: {regexp: '^public/logs/'}

  # catch-all
  - backendId: general-purpose
    when: all
```

## Backend Types

### AWS

The `aws` backend type stores objects in an S3 bucket.
Objects are stored in the bucket using their full name.

Each backend has the following configuration parameters:
 * `bucket`
 * `accessKeyId`
 * `secretAccessKey`
 * `signGetUrls` (optional, default false)

The bucket parameter names the bucket in which to store the objects.
You must pre-create the bucket in the appropriate region.
The credentials should correspond to an IAM user with the following policy, with `$BUCKET` replaced with the bucket name:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Stmt1462988481000",
            "Effect": "Allow",
            "Action": [
                "s3:GetBucketCORS",
                "s3:PutBucketCORS",
                "s3:DeleteObject",
                "s3:GetObject",
                "s3:PutObject",
                "s3:PutObjectAcl",
                "s3:ListBucket",
                "s3:GetBucketLocation",
                "s3:GetObjectTagging",
                "s3:ListMultipartUploadParts",
                "s3:AbortMultipartUpload",
                "s3:PutObjectTagging"
            ],
            "Resource": [
                "arn:aws:s3:::$BUCKET",
                "arn:aws:s3:::$BUCKET/*"
            ]
        }
    ]
}
```

The `signGetUrls` config controls the form of the URLs used for simple downloads (such as for loading artifacts in a browser).
In general, if the bucket contents are public, set this to `false` as signatures are unnecessary; otherwise, set it to true.

## Middleware

The object service supports "middleware" that can intercept download requests.
This is configured with the `object.middleware` configuration value.
This is a JSON array containing a sequence of middleware specifications, which will be tried in order.
Each is a JSON object that must have at least a `middlewareType` giving the type of middleware; the remaining properties are specific to that middleware type.

## Middleware Types

No middleware types are defined yet!
